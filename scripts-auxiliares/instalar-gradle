#!/bin/bash

verde="\033[1;32m"
vermelho="\033[1;31m"
amarelo="\033[1;33m"
normal="\033[0m"

versao=0
urls="$(curl -sL https://gradle.org/releases/ | grep 'https://services.gradle.org/distributions/gradle-' | grep -v 'all' | awk '{print $4}' | cut -f 2 -d '=')"

for url in $urls
do
    versao_atual="$(echo "$url" | grep -oP '(?<=gradle-)\d+\.\d+')"
    if (( $(echo "$versao_atual > $versao" | bc -l) )); then
        export versao=$versao_atual
    fi
done

if [ -d /opt/Gradle/gradle-$versao ]; then
    echo "A versão mais recente já está instalada."
    echo "Versão atual: $versao"
    
    while [[ "$resposta_instalar_gradle" != [sSnN] ]]; do
        read -p "Deseja reinstalar? [s/n] " resposta_instalar_gradle < /dev/tty
    done

    if [[ "$resposta_instalar_gradle" == [nN] ]]; then
        exit 0
    fi
fi

echo -e "\n${verde}Instalando Gradle $versao...${normal}\n"

if [ ! $(command -v java) ]; then
    echo -e "\n${vermelho}O comando \"java\" não foi encontrado.${normal}\n"

    while [[ "$resposta_instalar_java" != [sSnN] ]]; do
        read -p "Deseja instalar o OpenJDK 21? [s/n] " resposta_instalar_java < /dev/tty
    done

    if [[ "$resposta_instalar_java" == [nN] ]]; then
        echo -e "\n${amarelo}A instalação do Java será pulada. Entretando, você precisará instalar o Java posteriormente para utilizar corremente o Gradle.${normal}\n"
    else
        export instalar_java=true
    fi
fi

export binario="gradle"
export dir_instalacao_base="/opt/Gradle"
export dir_instalacao="$dir_instalacao_base/gradle-$versao"
export dir_instalacao_simbolico="$dir_instalacao_base/gradle"
export url_arquivo="https://services.gradle.org/distributions/gradle-$versao-bin.zip"
export pacote_java="java-21-openjdk"

set -e
sudo -E -- bash -c '
    if [ "$instalar_java" = true ]; then
         set -e
         echo -e "\n${verde}Procedendo para a instalação do OpenJDK 21...${normal}\n"
         echo -e "\n${amarelo}Atualizando a lista de pacotes...${normal}\n"
         repositorio="$(zypper info $pacote_java | grep -E "Reposit.*:" | sed -n "s/^.*: *//p")"

         zypper --gpg-auto-import-keys refresh -f -r "$repositorio"

         echo -e "\n${amarelo}Instalando o OpenJDK 21...${normal}\n"
         zypper -n install -y java-21-openjdk

         echo -e "\n${amarelo}Definindo a variável de ambiente JAVA_HOME...${normal}\n"
         sudo -u $SUDO_USER fish -c "set --export -U JAVA_HOME (dirname (dirname (readlink -f (which java))))"
         set +e
    fi

    echo -e "\nBaixando Gradle $versao...\n"
    arquivo_baixado="/tmp/$(basename $url_arquivo)"
    wget -q --show-progress --read-timeout=5 --tries=0 -cO ${arquivo_baixado} ${url_arquivo}

    echo -e "\nExtraindo o arquivo baixado \"$arquivo_baixado\" para \"$dir_instalacao_base\"...\n"
    rm -rf "$dir_instalacao"
    mkdir -p "$dir_instalacao_base"
    unzip -o ${arquivo_baixado} -d /opt/Gradle/ | pv -l >/dev/null
    rm -f $dir_instalacao_simbolico
    ln -s $dir_instalacao $dir_instalacao_simbolico
    rm -f /usr/local/bin/$binario
    ln -s $dir_instalacao_simbolico/bin/$binario /usr/local/bin/$binario
    rm -f ${arquivo_baixado}
'

echo -e "\n${verde}Instalação concluída. Você pode executar o comando \"gradle\" pelo terminal.${normal}\n"
